## Description

This ROS packages wraps the [mediapipe library](https://google.github.io/mediapipe/) inside a ROS node.

In order to be able to use the mediapipe library, a new rule has been added to the Bazel build framework to create a new shared library (libmediapipe.so) which includes a single class with a simple API to interface with the mediapipe library. This class has the following API:

* **Constructor**: initializes some internal attributes.

* **init(const std::string &graph)**: initializes the basic mediapipe data structures and loads a user defined graph to be executed.

* **process_frame(cv::Mat &input_frame,cv::Mat &output_frame)**: processes a single frame through the configured graph and returns the output stream generated by the mediapipe library. At the moment only the output image stream can be used.

* **Destructor**: frees all internal attributes.

The generated shared library is then used to build the ROS node.

The mediapipe library is locally downloaded, patched and built with the regular catkin_make command before the actual ROS node is build. By doing so, some required paths to header and shared library files can be easily known.

At run-time, the mediapipe library expects to find the graph definition files at a relative path from where it is being executed. To solve this problem, the catkin_make build process end by creating a soft link to the local mediapipe library path in the default ROS_HOME (~/.ros) folder.

# ROS Interface
### Topic publishers
  - ~**landmarks_3d** (iri_skeleton_msgs/skeleton3D.msg)
  - ~**landmarks** (iri_people_detection_msgs/peopleDetection.msg)
  - ~**image_out** (sensor_msgs/Image.msg): output image topic.
### Topic subscribers
  - ~**image_in** (sensor_msgs/Image.msg): input image topic.

### Parameters
- ~**rate** (Double; default: 10.0; min: 0.1; max: 1000) The main node thread loop rate in Hz. 

## Requirements

To compile mediapipe in C++, [Bazel]() is required. Download the [bazel binary](https://github.com/bazelbuild/bazelisk/releases/download/v1.10.1/bazelisk-linux-amd64) and copy it into the default *bin* folder:
```
chmod a+x bazelisk-linux-amd64
sudo cp bazelisk-linux-amd64 /usr/local/bin/bazel
```
Bazel also needs some python3 dependencies, install them with the following command:
```
sudo apt-get install python3-numpy
```
Install some required system dependencies with the following command:
```
sudo apt-get install libgflags-dev libgoogle-glog-dev
```

Before trying to build this ROS node, it is necessary to ensure that at least version 8 of the C++ compiler is available. To check the current version of the C++ compiler, execute the following command:
```
g++ --version
```
If the reported version is 8 o higher, nothing has to be done. Otherwise, it is necessary to install a newer version of the C++ compiler. To do so, add a new software repository with these commands:
```
sudo apt install software-properties-common
sudo add-apt-repository ppa:ubuntu-toolchain-r/test
```
Then install the new version of the C++ compiler (in this case version 8) with the following command:
```
sudo apt install gcc-8 g++-8
```
In order to be able to switch between compiler versions, add the current and new versions of the C++ compiler to the update-alternative application:
```
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 80 --slave /usr/bin/g++ g++ /usr/bin/g++-8 --slave /usr/bin/gcov gcov /usr/bin/gcov-8
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 70 --slave /usr/bin/g++ g++ /usr/bin/g++-7 --slave /usr/bin/gcov gcov /usr/bin/gcov-7
```
And the choose the desired compiler version with the following command:
```
sudo update-alternatives --config gcc
```
When executing the previous command make sure to select at least the version 8 of the C++ compiler, otherwise the build process will fail.

## Installation

Move to the active workspace:
```bash
roscd && cd ../src
```
Clone the repository: 
```bash
git clone <url>
```
Install ROS dependencies:
```
roscd
cd ..
rosdep install -i -r --from-paths src
```
Compile the workspace:
```
catkin_make
```

## How to use it

- Standalone test

  `roslaunch iri_mediapipe_graph test.launch`

This example test will launch this ROS node together with a webcam and display the processed image.

## Disclaimer  

Copyright (C) Institut de Robòtica i Informàtica Industrial, CSIC-UPC.
Mantainer IRI labrobotics (labrobotica@iri.upc.edu)

This package is distributed in the hope that it will be useful, but without any warranty. It is provided "as is" without warranty of any kind, either expressed or implied, including, but not limited to, the implied warranties of merchantability and fitness for a particular purpose. The entire risk as to the quality and performance of the program is with you. should the program prove defective, the GMR group does not assume the cost of any necessary servicing, repair  or correction.

In no event unless required by applicable law the author will be liable to you for damages, including any general, special, incidental or consequential damages arising out of the use or inability to use the program (including but not limited to loss of data or data being rendered inaccurate or losses sustained by you or third parties or a failure of the program to operate with any other programs), even if the author has been advised of the possibility of such damages.

You should have received a copy of the GNU Lesser General Public License along with this program. If not, see <http://www.gnu.org/licenses/>
